package edu.ucla.cs.cve.analysis;

import java.io.File;
import java.io.IOException;
import java.nio.charset.Charset;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.apache.commons.io.FileUtils;

public class ProcessBoaOutput {
	public static void main(String[] args) throws IOException {
		String outputPath = "/home/troy/ONR/CVE-analysis/boa-output-commit-with-cves.txt";
		File outputFile = new File(outputPath);
		ArrayList<GitHubRevision> commits = new ArrayList<GitHubRevision>();
		List<String> lines = FileUtils.readLines(outputFile, Charset.defaultCharset());
		HashSet<String> projects = new HashSet<String>();
		GitHubRevision curr = null;
		for(int i = 1; i < lines.size(); i++) {
			String line = lines.get(i);
			if(line.startsWith("data[] =")) {
				line = line.substring(9);
				String[] ss = line.split(" ;;; ");
				String name = ss[0];
				String link = ss[1];
				String sha = ss[2];
				String timestamp = ss[3];
				String log = ss[4];
				Date date = new Date(Long.parseLong(timestamp) / 1000);
				SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
				String dateS = formatter.format(date);
				GitHubRevision commit = new GitHubRevision(name, link, log, sha, dateS);
				commits.add(commit);
				curr = commit;
				projects.add(name);
			} else {
				if(curr != null) {
					curr.commit_message = curr.commit_message + System.lineSeparator() + line;
				}
			}
		}
		
		System.out.println("Num of GitHub projects: " + projects.size());
		System.out.println("Num of GitHub commits: " + commits.size());
		
		HashSet<String> cves = new HashSet<String>();
		Pattern pattern = Pattern.compile("CVE-20\\d+-\\d+", Pattern.CASE_INSENSITIVE);
		for(GitHubRevision commit : commits) {
			String log = commit.commit_message;
			Matcher matcher = pattern.matcher(log);
			while (matcher.find()) {
				String cve = matcher.group();
				cves.add(cve);
			}
		}
		
		System.out.println("Num of mentioned CVEs: " + cves.size());
	}
}
